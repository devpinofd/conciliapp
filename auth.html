<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Registro de Cobranzas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f0f9ff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .auth-container {
            background: linear-gradient(180deg, #ffffff, #f1f5f9);
            max-width: 400px;
            width: 100%;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            height: 80px;
        }
        .logo-container img {
            max-height: 100%;
            width: auto;
            object-fit: contain;
        }
        .form-wrapper {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .form-wrapper.hidden {
            opacity: 0;
            transform: scale(0.98);
            position: absolute;
            pointer-events: none;
            width: calc(100% - 64px); /* Ajuste para el padding */
        }
        h2 {
            text-align: center;
            color: #0f172a;
            margin-bottom: 24px;
            font-weight: 600;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #334155;
            font-weight: 500;
            font-size: 14px;
        }
        .input-container {
            position: relative;
        }
        input {
            width: 100%;
            padding: 14px;
            padding-right: 45px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #ffffff;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .password-toggle {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #64748b;
        }
        .password-toggle:hover {
            color: #1e40af;
        }
        .button {
            position: relative;
            padding: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            background-color: #2563eb;
            color: #ffffff;
            transition: background-color 0.3s, transform 0.1s;
            min-height: 50px; /* Altura fija para evitar saltos */
        }
        .button:hover {
            background-color: #1e40af;
        }
        .button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        .button .button-text {
            transition: opacity 0.2s;
        }
        .button .spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -12px;
            margin-left: -12px;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .button.loading .spinner {
            display: block;
        }
        .button.loading .button-text {
            opacity: 0;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .switch-form-text {
            text-align: center;
            margin-top: 24px;
        }
        .switch-form-text a {
            color: #2563eb;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
        }
        .switch-form-text a:hover {
            text-decoration: underline;
        }
        .notification {
            position: fixed; top: 20px; right: 20px; background-color: #10b981; color: #ffffff; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        .notification.visible { display: block; opacity: 1; }
        .notification.error { background-color: #ef4444; }
        .error { color: #ffffff; font-size: 14px; margin-top: 5px; display: none; }
        
        .branding-section {
            margin-top: 24px;
            color: #64748b;
            font-size: 14px;
            text-align: center;
        }
        .branding-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }
        .branding-logos svg {
            width: 22px;
            height: 22px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="auth-container">
            <div class="logo-container">
                <img src="https://drive.google.com/uc?export=view&id=1rTAUyKNw0qkSb3XSh-8N7P8fHCIF3GIC" alt="Conciliapp Logo">
            </div>

            <div id="login-form-wrapper" class="form-wrapper">
                <h2>Inicio de Sesión</h2>
                <form id="login-form">
                    <div class="input-group">
                        <label for="email">Correo Electrónico:</label>
                        <input type="email" id="email" required>
                        <span id="emailError" class="error">Por favor, ingrese un correo válido.</span>
                    </div>
                    <div class="input-group">
                        <label for="password">Contraseña:</label>
                        <div class="input-container">
                            <input type="password" id="password" required>
                            <span class="password-toggle" onclick="togglePasswordVisibility('password', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </span>
                        </div>
                        <span id="passwordError" class="error">La contraseña no puede estar vacía.</span>
                    </div>
                    <button type="submit" class="button">
                        <span class="button-text">Ingresar</span>
                        <div class="spinner"></div>
                    </button>
                </form>
                <p class="switch-form-text">¿No tienes cuenta? <a onclick="switchForm('register')">Regístrate aquí.</a></p>
            </div>

            <div id="register-form-wrapper" class="form-wrapper hidden">
                <h2>Crear Cuenta</h2>
                <form id="register-form">
                    <div class="input-group">
                        <label for="reg-name">Nombre:</label>
                        <input type="text" id="reg-name" required>
                        <span id="regNameError" class="error">El nombre no puede estar vacío.</span>
                    </div>
                    <div class="input-group">
                        <label for="reg-email">Correo Electrónico:</label>
                        <input type="email" id="reg-email" required>
                        <span id="regEmailError" class="error">Por favor, ingrese un correo válido.</span>
                    </div>
                    <div class="input-group">
                        <label for="reg-password">Contraseña:</label>
                        <div class="input-container">
                            <input type="password" id="reg-password" required>
                             <span class="password-toggle" onclick="togglePasswordVisibility('reg-password', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </span>
                        </div>
                        <span id="regPasswordError" class="error">La contraseña debe tener al menos 6 caracteres.</span>
                    </div>
                    <button type="submit" class="button">
                        <span class="button-text">Registrar</span>
                        <div class="spinner"></div>
                    </button>
                </form>
                <p class="switch-form-text">¿Ya tienes cuenta? <a onclick="switchForm('login')">Inicia sesión aquí.</a></p>
            </div>
        </div>
        <div class="branding-section">
            <span>Powered by</span>
            <div class="branding-logos">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.18 10.33V13.67H2.82C2.82 17.59 5.92 20.78 9.84 20.87C14.12 20.97 17.62 17.47 17.62 13.19C17.62 12.04 17.37 10.95 16.92 9.96L14.82 8.04C15.82 9.34 16.42 10.99 16.42 12.83C16.42 16.63 13.42 19.71 9.63 19.67C6.33 19.64 3.63 17.18 3.63 13.88V10.33H9.18Z" fill="#4285F4"></path><path d="M16.92 9.96C15.52 7.73 13.02 6.33 10.17 6.33C8.42 6.33 6.82 6.95 5.57 7.99L3.42 6.04C5.12 4.49 7.42 3.5 9.97 3.5C10.82 3.5 11.67 3.64 12.47 3.9L14.52 2C12.42 0.7 9.82 0 6.97 0C4.52 0 2.27 0.84 0.52 2.3L2.82 4.45C3.82 3.55 5.22 2.92 6.72 2.92C8.82 2.92 10.67 3.95 11.72 5.5L12.47 3.9C13.42 4.6 14.22 5.43 14.82 6.33H19.22V9.96H16.92Z" fill="#34A853"></path><path d="M0.52 2.3C2.27 3.75 3.32 5.9 3.32 8.25C3.32 9.25 3.12 10.2 2.82 11.05V13.67H0V11.36C0 9.06 0.87 6.96 2.42 5.45L0.52 2.3Z" fill="#FBBC05"></path><path d="M24 10.33V13.67H21.18C21.18 17.59 18.08 20.78 14.16 20.87C9.88 20.97 6.38 17.47 6.38 13.19C6.38 12.04 6.63 10.95 7.08 9.96L9.18 8.04C8.18 9.34 7.58 10.99 7.58 12.83C7.58 16.63 10.58 19.71 14.37 19.67C17.67 19.64 20.37 17.18 20.37 13.88V10.33H24Z" fill="#EA4335"></path></svg>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L22.5 21.25H1.5L12 2Z" fill="url(#p0)"></path><path d="M12 2L1.5 21.25L12 19.5V2Z" fill="url(#p1)"></path><defs><linearGradient id="p0" x1="12" y1="2" x2="12" y2="21.25" gradientUnits="userSpaceOnUse"><stop stop-color="#4285F4"></stop><stop offset="1" stop-color="#34A853"></stop></linearGradient><linearGradient id="p1" x1="12" y1="2" x2="12" y2="19.5" gradientUnits="userSpaceOnUse"><stop stop-color="#4285F4"></stop><stop offset="1" stop-color="#34A853" stop-opacity="0.5"></stop></linearGradient></defs></svg>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.1 12c0-3.78-2.59-6.9-6.04-7.75l-.01.01c-.75-.18-1.55-.26-2.36-.26C7.3 4 3.69 7.61 3.69 12s3.61 8 8 8c3.85 0 7.2-2.74 7.93-6.47H11.69V12H20.1z" fill="#4285F4"></path><path d="M11.69 4C9.53 4 7.58 4.9 6.16 6.39l2.47 2.47c.8-.8 1.88-1.27 3.06-1.27 1.87 0 3.42 1.35 3.73 3.12h-3.73V7.59V4z" fill="#34A853"></path><path d="M19.82 13.53A8.37 8.37 0 0115.69 17.6l-2.5-2.5c1.09-.51 1.87-1.54 2.03-2.79h4.6v1.22z" fill="#FBBC05"></path><path d="M3.8 12.21c0-.8.13-1.57.36-2.31l-2.5-2.5A8.99 8.99 0 00.69 12c0 3.89 2.5 7.21 5.82 8.39l2.45-2.45A5.85 5.85 0 013.8 12.21z" fill="#EA4335"></path></svg>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        const webAppUrl = "<?!= url ?>";
        const loginWrapper = document.getElementById('login-form-wrapper');
        const registerWrapper = document.getElementById('register-form-wrapper');

        function switchForm(to) {
            const formToHide = (to === 'register') ? loginWrapper : registerWrapper;
            const formToShow = (to === 'register') ? registerWrapper : loginWrapper;
            
            formToHide.classList.add('hidden');
            setTimeout(() => {
                formToHide.style.position = 'absolute';
                formToShow.style.position = 'relative';
                formToShow.classList.remove('hidden');
            }, 300);
        }

        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            icon.innerHTML = isPassword 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} visible`;
            setTimeout(() => { notification.classList.remove('visible'); }, 4000);
        }

        function validateForm(formId, fields) {
            let isValid = true;
            document.querySelectorAll(`#${formId} .error`).forEach(el => el.style.display = 'none');

            for (const field of fields) {
                const input = document.getElementById(field.id);
                const errorEl = document.getElementById(field.id + 'Error');
                if (!input.value.trim() || (field.regex && !field.regex.test(input.value)) || (field.minLength && input.value.length < field.minLength)) {
                    errorEl.style.display = 'block';
                    isValid = false;
                }
            }
            return isValid;
        }

        function handleFormSubmit(e, formId, fields, serverFunction) {
            e.preventDefault();
            if (!validateForm(formId, fields)) return;

            const button = e.target.querySelector('button');
            const buttonText = button.querySelector('.button-text');
            const originalButtonText = buttonText.textContent;
            
            button.classList.add('loading');
            button.disabled = true;

            const params = fields.map(field => document.getElementById(field.id).value);

            const successCallback = (response) => {
                if (formId === 'login-form') {
                    if (response && response.status === 'SUCCESS' && response.token) {
                        sessionStorage.setItem('sessionToken', response.token);
                        showNotification('Inicio de sesión exitoso. Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.top.location.href = webAppUrl + '?token=' + response.token + '&new_session=true';
                        }, 1000);
                    } else {
                        // Si el login no es exitoso pero la llamada sí, es un error de credenciales
                        showNotification(response.message || 'Credenciales incorrectas.', 'error');
                        resetButtonState();
                    }
                } else { // Register form
                    showNotification('Cuenta creada con éxito. Ahora puede iniciar sesión.', 'success');
                    resetButtonState();
                    switchForm('login');
                }
            };

            const failureCallback = (error) => {
                showNotification(`Error: ${error.message}`, 'error');
                resetButtonState();
            };
            
            const resetButtonState = () => {
                button.classList.remove('loading');
                button.disabled = false;
            };

            google.script.run
                .withSuccessHandler(successCallback)
                .withFailureHandler(failureCallback)
                [serverFunction](...params);
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            const fields = [
                { id: 'email', regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                { id: 'password' }
            ];
            handleFormSubmit(e, 'login-form', fields, 'processLogin');
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            const fields = [
                { id: 'reg-name' },
                { id: 'reg-email', regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                { id: 'reg-password', minLength: 6 }
            ];
            handleFormSubmit(e, 'register-form', fields, 'registerUser');
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loginWrapper.classList.remove('hidden');
            registerWrapper.classList.add('hidden');
            registerWrapper.style.position = 'absolute';
        });
    </script>
</body>
</html>