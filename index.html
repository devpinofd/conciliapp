<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Formulario de Cobranzas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f0f9ff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .form-container, .records-container {
            background: linear-gradient(180deg, #ffffff, #f1f5f9);
            max-width: 1200px;
            width: 100%;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .form-container:hover, .records-container:hover {
            transform: translateY(-2px);
        }
        .form-header, .records-header {
            background: linear-gradient(90deg, #1d4ed8, #3b82f6);
            color: #ffffff;
            padding: 28px;
            text-align: center;
            border-bottom: 4px solid #1e40af;
        }
        .form-body, .records-body {
            padding: 28px;
        }
        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }
        .form-section {
            margin-bottom: 28px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: #0f172a;
            font-weight: 500;
            font-size: 15px;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #ffffff;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 28px;
        }
        .button {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.2s;
        }
        .button-primary {
            background-color: #2563eb;
            color: #ffffff;
        }
        .button-primary:hover {
            background-color: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .button-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .button-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .button-danger:disabled {
            background-color: #fca5a5;
            cursor: not-allowed;
        }
        .button-secondary {
            background-color: #f1f5f9;
            color: #0f172a;
        }
        .button-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .button-ghost {
            background: none;
            border: none;
            color: #2563eb;
            padding: 0;
            text-align: left;
            font-weight: 500;
        }
        .button-ghost:hover {
            color: #1e40af;
            text-decoration: underline;
        }
        .ghost-delete svg {
            width: 22px;
            height: 22px;
            fill: #ef4444;
            transition: fill 0.3s;
        }
        .ghost-delete:hover svg {
            fill: #dc2626;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10b981;
            color: #ffffff;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-100px);
            opacity: 0;
        }
        .notification.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .factura-details {
            margin-top: 10px;
            padding: 14px;
            background-color: #f8fafc;
            border-left: 4px solid #2563eb;
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
            display: none;
        }
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .records-table th, .records-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #dbeafe;
        }
        .records-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #0f172a;
        }
        .records-table tr:hover {
            background-color: #f8fafc;
        }
        @media screen and (max-width: 768px) {
            .records-table thead {
                display: none;
            }
            .records-table, .records-table tbody, .records-table tr, .records-table td {
                display: block;
                width: 100%;
            }
            .records-table tr {
                margin-bottom: 20px;
                border: 1px solid #dbeafe;
                border-radius: 8px;
                overflow: hidden;
            }
            .records-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                border-bottom: 1px solid #f1f5f9;
            }
            .records-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 14px;
                width: 45%;
                text-align: left;
                font-weight: 500;
                color: #475569;
            }
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .button {
                width: 100%;
            }
        }
        .loading-spinner-container {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background: linear-gradient(180deg, #ffffff, #f1f5f9);
            margin: 15% auto;
            padding: 28px;
            border: 1px solid #dbeafe;
            width: 80%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        #tasa-bcv {
            text-align: center;
            font-size: 15px;
            color: #ffffff;
            margin-bottom: 20px;
        }
        #tasa-bcv span {
            font-weight: 600;
            color: #ffffff;
        }
        #refresh-button-container {
            text-align: right;
            margin-bottom: 12px;
        }
        .error {
            color: #ef4444;
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 10px;
            display: none;
        }
        .app-header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            box-sizing: border-box;
        }
        .app-header h2 {
            color: #0f172a;
            font-size: 20px;
            margin: 0;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-info span {
            font-weight: 500;
            color: #334155;
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div id="loading-spinner" class="loading-spinner-container">
        <div class="spinner"></div>
    </div>

    <header class="app-header">
        <h2>Bienvenido, <?!= user.name ?></h2>
        <div class="user-info">
            <span>(<?!= user.email ?>)</span>
            <button id="logout-button" class="button button-danger">Cerrar Sesión</button>
        </div>
    </header>

    <div class="form-container">
        <header class="form-header">
            <h1>Registro de Cobranzas</h1>
        </header>
        <div style="text-align: center; margin-bottom: 20px;">
            <p id="tasa-oficial" class="tasa-oficial-text">Cargando...</p>
        </div>
        <main class="form-body">
            <form id="formulario">
                <div class="form-section">
                    <label for="vendedor">Seleccione el vendedor:</label>
                    <select id="vendedor" name="vendedor" required>
                        <option value="" disabled selected>Cargando vendedores...</option>
                    </select>
                    <span id="vendedorError" class="error">Por favor, seleccione un vendedor.</span>
                </div>
                <div class="form-section">
                    <label for="cliente">Seleccione el cliente:</label>
                    <select id="cliente" name="cliente" required disabled>
                        <option value="" disabled selected>Seleccione un cliente</option>
                    </select>
                    <span id="clienteError" class="error">Por favor, seleccione un cliente.</span>
                </div>
                <div class="form-section">
                    <label for="factura">Seleccione la factura:</label>
                    <select id="factura" name="factura" required disabled>
                        <option value="" disabled selected>Seleccione una factura</option>
                    </select>
                    <div id="factura-details" class="factura-details"></div>
                    <span id="facturaError" class="error">Por favor, seleccione una factura.</span>
                </div>
                <div class="form-section">
                    <label for="monto-pagado">Monto pagado:</label>
                    <input type="number" id="monto-pagado" name="montoPagado" step="0.01" min="0.01" required>
                    <span id="montoError" class="error">El monto debe ser mayor a 0.</span>
                </div>
                <div class="form-section">
                    <label for="forma-pago">Forma de Pago:</label>
                    <select id="forma-pago" name="formaPago" required>
                        <option value="" disabled selected>Seleccione...</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Pago Móvil">Pago Móvil</option>
                        <option value="Efectivo $">Efectivo $</option>
                        <option value="Zelle">Zelle</option>
                    </select>
                    <span id="formaPagoError" class="error">Por favor, seleccione una forma de pago.</span>
                </div>
                <div class="form-section">
                    <label for="banco_emisor">Banco Emisor:</label>
                    <select id="banco_emisor" name="bancoEmisor" required>
                        <option value="" disabled selected>Seleccione un banco</option>
                        <option value="NO APLICA">NO APLICA</option>
                        <option value="100% banco (0156)">100% banco (0156)</option>
                        <option value="Activo (0171)">Activo (0171)</option>
                        <option value="Banca amiga (0172)">Banca amiga (0172)</option>
                        <option value="Bancaribe (0114)">Bancaribe (0114)</option>
                        <option value="Banco Agrícola (0166)">Banco Agrícola (0166)</option>
                        <option value="Banco del tesoro (0163)">Banco del tesoro (0163)</option>
                        <option value="Banesco (0134)">Banesco (0134)</option>
                        <option value="Banplus (0174)">Banplus (0174)</option>
                        <option value="BNC- Banco Nacional de Crédito (0191)">BNC- Banco Nacional de Crédito (0191)</option>
                        <option value="del sur (0157)">del sur (0157)</option>
                        <option value="Exterior (0115)">Exterior (0115)</option>
                        <option value="Fondo Común (0151)">Fondo Común (0151)</option>
                        <option value="Mercantil (0105)">Mercantil (0105)</option>
                        <option value="Plaza (0138)">Plaza (0138)</option>
                        <option value="Provincial (0108)">Provincial (0108)</option>
                        <option value="sofitasa (0137)">sofitasa (0137)</option>
                        <option value="Venezolano de Crédito (0104)">Venezolano de Crédito (0104)</option>
                        <option value="Venezuela (0102)">Venezuela (0102)</option>
                    </select>
                    <span id="bancoEmisorError" class="error">Por favor, seleccione un banco emisor.</span>
                </div>
                <div class="form-section">
                    <label for="banco_receptor">Banco Receptor:</label>
                    <select id="banco_receptor" name="bancoReceptor" required>
                        <option value="" disabled selected>Seleccione un banco</option>
                        <option value="NO APLICA">NO APLICA</option>
                        <option value="JURIDICA BANESCO-1948">JURIDICA BANESCO-1948</option>
                        <option value="JURIDICA BNC- 8120">JURIDICA BNC- 8120</option>
                        <option value="JURIDICA VENEZUELA- 4079">JURIDICA VENEZUELA- 4079</option>
                        <option value="JURIDICA VENEZUELA -6496">JURIDICA VENEZUELA -6496</option>
                        <option value="PERSONAL BANESCO -6401">PERSONAL BANESCO -6401</option>
                        <option value="PERSONAL BNC -9347">PERSONAL BNC -9347</option>
                        <option value="PERSONAL VENEZUELA -6386">PERSONAL VENEZUELA -6386</option>
                        <option value="PERSONAL VENEZUELA -8629">PERSONAL VENEZUELA -8629</option>
                    </select>
                    <span id="bancoReceptorError" class="error">Por favor, seleccione un banco receptor.</span>
                </div>
                <div class="form-section">
                    <label for="nro-referencia">Número de Referencia:</label>
                    <input type="text" id="nro-referencia" name="nroReferencia" required>
                    <span id="referenciaError" class="error">El número de referencia debe tener entre 4 y 20 caracteres.</span>
                </div>
                <div class="form-section">
                    <label for="tipo-cobro">Tipo de Cobro:</label>
                    <select id="tipo-cobro" name="tipoCobro" required>
                        <option value="" disabled selected>Seleccione...</option>
                        <option value="Abono">Abono</option>
                        <option value="Cobro Total">Cobro Total</option>
                    </select>
                    <span id="tipoCobroError" class="error">Por favor, seleccione un tipo de cobro.</span>
                </div>
                <div class="form-section">
                    <label for="fecha-transferencia-pago">Fecha de la Transferencia o Pago:</label>
                    <input type="date" id="fecha-transferencia-pago" name="fechaTransferenciaPago" required>
                    <span id="fechaError" class="error">Por favor, seleccione una fecha válida.</span>
                </div>
                <div class="form-section">
                    <label for="observaciones">Observaciones (Opcional):</label>
                    <textarea id="observaciones" name="observaciones" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button button-primary">Enviar Cobranza</button>
                </div>
            </form>
        </main>
    </div>

    <div class="records-container">
        <header class="records-header">
            <h2>Registros Enviados Recientemente</h2>
            <div id="tasa-bcv"></div>
        </header>
        <main class="records-body">
            <div id="refresh-button-container">
                <button id="refresh-data-btn" class="button button-secondary">Refrescar Caché de Datos</button>
            </div>
            <p id="records-status">Cargando registros...</p>
            <table class="records-table">
                <thead>
                    <tr>
                        <th data-label="Fecha">Fecha</th>
                        <th data-label="Vendedor">Vendedor</th>
                        <th data-label="Cliente">Cliente</th>
                        <th data-label="Factura">Factura</th>
                        <th data-label="Monto">Monto</th>
                        <th data-label="Banco Emisor">Banco Emisor</th>
                        <th data-label="Banco Receptor">Banco Receptor</th>
                        <th data-label="Referencia">Referencia</th>
                        <th data-label="Acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody id="registros-table-body"></tbody>
            </table>
        </main>
    </div>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h4>Confirmar Eliminación</h4>
            <p>¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn" class="button button-danger">Eliminar</button>
                <button id="cancel-delete-btn" class="button button-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const webAppUrl = "<?!= url ?>";

        const clientCache = {
            TTL: 3600 * 1000,
            PREFIX: 'formCobranza_',
            set(key, data) {
                try {
                    localStorage.setItem(this.PREFIX + key, JSON.stringify({ timestamp: new Date().getTime(), data }));
                } catch (e) {
                    console.error("Error guardando en localStorage", e);
                }
            },
            get(key) {
                try {
                    const itemStr = localStorage.getItem(this.PREFIX + key);
                    if (!itemStr) return null;
                    const item = JSON.parse(itemStr);
                    const isExpired = (new Date().getTime() - item.timestamp) > this.TTL;
                    if (isExpired) {
                        localStorage.removeItem(this.PREFIX + key);
                        return null;
                    }
                    return item.data;
                } catch (e) {
                    console.error("Error leyendo de localStorage", e);
                    return null;
                }
            },
            clear() {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(this.PREFIX)) localStorage.removeItem(key);
                    });
                    console.log("Caché de la aplicación limpiado.");
                } catch (e) {
                    console.error("Error limpiando localStorage", e);
                }
            }
        };

        class UiManager {
            constructor() {
                this.elements = {
                    notification: document.getElementById('notification'),
                    loadingSpinner: document.getElementById('loading-spinner'),
                    form: document.getElementById('formulario'),
                    vendedorSelect: document.getElementById('vendedor'),
                    clienteSelect: document.getElementById('cliente'),
                    facturaSelect: document.getElementById('factura'),
                    facturaDetailsDiv: document.getElementById('factura-details'),
                    recordsTableBody: document.getElementById('registros-table-body'),
                    recordsStatus: document.getElementById('records-status'),
                    deleteModal: document.getElementById('delete-modal'),
                    confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                    cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
                    tasaBcvDiv: document.getElementById('tasa-bcv'),
                    tasaOficial: document.getElementById('tasa-oficial'),
                    logoutButton: document.getElementById('logout-button')
                };
            }
            toggleLoading(show) { this.elements.loadingSpinner.style.display = show ? 'flex' : 'none'; }
            showNotification(message, type = 'success') { this.elements.notification.textContent = message; this.elements.notification.className = `notification ${type} visible`; setTimeout(() => this.elements.notification.classList.remove('visible'), 3000); }
            showDeleteModal() { this.elements.deleteModal.style.display = 'block'; }
            hideDeleteModal() { this.elements.deleteModal.style.display = 'none'; }
            updateBcvRate(rate) {
                if (rate) {
                    this.elements.tasaBcvDiv.innerHTML = `Tasa Oficial BCV: <span>Bs. ${rate.toFixed(2)}</span>`;
                    this.elements.tasaOficial.textContent = `Bs. ${rate.toFixed(2)}`;
                } else {
                    this.elements.tasaBcvDiv.innerHTML = 'No se pudo obtener la tasa BCV.';
                    this.elements.tasaOficial.textContent = 'No disponible';
                }
            }
            updateRecordsTable(records) {
                this.elements.recordsTableBody.innerHTML = '';
                if (records.length === 0) {
                    this.elements.recordsStatus.textContent = 'No hay registros para mostrar.';
                    return;
                }
                records.forEach(record => {
                    const row = this.elements.recordsTableBody.insertRow();
                    row.innerHTML = `
                        <td data-label="Fecha">${record.fechaEnvio || record.fecha}</td>
                        <td data-label="Vendedor">${record.vendedor}</td>
                        <td data-label="Cliente">${record.clienteNombre || record.cliente}</td>
                        <td data-label="Factura">${record.factura}</td>
                        <td data-label="Monto">${record.monto}</td>
                        <td data-label="Banco Emisor">${record.bancoEmisor}</td>
                        <td data-label="Banco Receptor">${record.bancoReceptor}</td>
                        <td data-label="Referencia">${record.referencia}</td>
                        <td data-label="Acciones">
                            ${record.puedeEliminar ? `<button class="ghost-delete" data-row-index="${record.rowIndex}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>` : ''}
                        </td>
                    `;
                });
                this.elements.recordsStatus.textContent = '';
            }
            resetForm() {
                this.elements.form.reset();
                this.elements.facturaDetailsDiv.style.display = 'none';
                this.elements.clienteSelect.innerHTML = '<option value="" disabled selected>Seleccione un cliente</option>';
                this.elements.clienteSelect.disabled = true;
                this.elements.facturaSelect.innerHTML = '<option value="" disabled selected>Seleccione una factura</option>';
                this.elements.facturaSelect.disabled = true;
                document.querySelectorAll('.error').forEach(el => el.style.display = 'none');
            }
            populateSelect(selectElement, optionsHtml, placeholder = 'Seleccione una opción') {
                selectElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>` + optionsHtml;
                selectElement.disabled = false;
            }
            showFacturaDetails(factura) {
                this.elements.facturaDetailsDiv.innerHTML = `<strong>Saldo:</strong> ${factura.mon_sal} ${factura.cod_mon} <br><strong>Fecha Emisión:</strong> ${factura.fec_ini}`;
                this.elements.facturaDetailsDiv.style.display = 'block';
            }
        }

        class DataManager {
            constructor(ui) {
                this.ui = ui;
                this.facturasPendientes = [];
                this.currentVendedor = null;
                this.registroToDelete = null;
            }
            
            async loadInitialData(forceRefresh = false) {
                try {
                    this.ui.toggleLoading(true);
                    await Promise.all([
                        this.loadVendedores(forceRefresh),
                        this.loadBcvRate(),
                        this.loadRecords()
                    ]);
                } catch (error) {
                    this.ui.showNotification(`Error al cargar datos iniciales: ${error.message}`, 'error');
                } finally {
                    this.ui.toggleLoading(false);
                }
            }

            async loadVendedores(forceRefresh = false) {
                const cacheKey = 'vendedores';
                let cachedData = forceRefresh ? null : clientCache.get(cacheKey);

                if (cachedData) {
                    this.ui.populateSelect(this.ui.elements.vendedorSelect, cachedData, 'Seleccione un vendedor');
                    // Si solo hay una opción (además del placeholder), la seleccionamos
                    if (this.ui.elements.vendedorSelect.options.length === 2) {
                        this.ui.elements.vendedorSelect.selectedIndex = 1;
                        this.ui.elements.vendedorSelect.dispatchEvent(new Event('change'));
                    }
                    return;
                }
                
                this.ui.elements.vendedorSelect.innerHTML = '<option disabled selected>Cargando...</option>';
                this.ui.elements.vendedorSelect.disabled = true;

                try {
                    const options = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .loadVendedores(forceRefresh);
                    });

                    clientCache.set(cacheKey, options);
                    this.ui.populateSelect(this.ui.elements.vendedorSelect, options, 'Seleccione un vendedor');
                    
                    // Si el usuario solo tiene un código de vendedor, lo seleccionamos por defecto.
                    if (this.ui.elements.vendedorSelect.options.length === 2) {
                        this.ui.elements.vendedorSelect.selectedIndex = 1;
                        this.ui.elements.vendedorSelect.dispatchEvent(new Event('change'));
                    }

                } catch (error) {
                    this.ui.elements.vendedorSelect.innerHTML = `<option disabled>Error al cargar</option>`;
                    this.ui.showNotification(`Error al cargar vendedores: ${error.message}`, 'error');
                }
            }

            async loadClientes() {
                const vendedor = this.ui.elements.vendedorSelect.value;
                this.currentVendedor = vendedor;
                if (!vendedor) { // Simplificado: si no hay vendedor, no hacer nada. El caso "Mostrar todos" se maneja en loadRecords.
                    this.ui.elements.clienteSelect.innerHTML = '<option disabled selected>Seleccione un cliente</option>';
                    this.ui.elements.clienteSelect.disabled = true;
                    this.ui.elements.facturaSelect.innerHTML = '<option disabled selected>Seleccione una factura</option>';
                    this.ui.elements.facturaSelect.disabled = true;
                    this.ui.elements.facturaDetailsDiv.style.display = 'none';
                    return;
                }
                const cacheKey = `clientes_${vendedor}`;
                let cachedData = clientCache.get(cacheKey);
                if (cachedData) {
                    this.ui.populateSelect(this.ui.elements.clienteSelect, cachedData, 'Seleccione un cliente');
                    return;
                }
                this.ui.toggleLoading(true);
                this.ui.elements.clienteSelect.innerHTML = '<option disabled>Cargando...</option>';
                this.ui.elements.clienteSelect.disabled = true;
                try {
                    const options = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .cargarClientesEnPregunta1(vendedor);
                    });
                    clientCache.set(cacheKey, options);
                    this.ui.populateSelect(this.ui.elements.clienteSelect, options, 'Seleccione un cliente');
                } catch (error) {
                    this.ui.elements.clienteSelect.innerHTML = '<option disabled>Error al cargar clientes</option>';
                    this.ui.showNotification(`Error al cargar clientes: ${error.message}`, 'error');
                } finally {
                    this.ui.toggleLoading(false);
                }
            }

            async loadFacturas() {
                const cliente = this.ui.elements.clienteSelect.value;
                const vendedor = this.ui.elements.vendedorSelect.value;
                if (!cliente || !vendedor) {
                    this.ui.elements.facturaSelect.innerHTML = '<option disabled selected>Seleccione una factura</option>';
                    this.ui.elements.facturaSelect.disabled = true;
                    this.ui.elements.facturaDetailsDiv.style.display = 'none';
                    return;
                }
                const cacheKey = `facturas_${vendedor}_${cliente}`;
                let cachedData = clientCache.get(cacheKey);
                if (cachedData) {
                    this.facturasPendientes = cachedData;
                    this.populateFacturasSelect();
                    return;
                }
                this.ui.toggleLoading(true);
                this.ui.elements.facturaSelect.innerHTML = '<option disabled>Cargando...</option>';
                this.ui.elements.facturaSelect.disabled = true;
                try {
                    const facturas = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .obtenerFacturas(vendedor, cliente);
                    });
                    clientCache.set(cacheKey, facturas);
                    this.facturasPendientes = facturas;
                    this.populateFacturasSelect();
                } catch (error) {
                    this.ui.elements.facturaSelect.innerHTML = '<option disabled>Error al cargar facturas</option>';
                    this.ui.showNotification(`Error al cargar facturas: ${error.message}`, 'error');
                } finally {
                    this.ui.toggleLoading(false);
                }
            }

            populateFacturasSelect() {
                const optionsHtml = this.facturasPendientes.length === 0
                    ? '<option disabled>No hay facturas pendientes</option>'
                    : this.facturasPendientes.map(f => `<option value="${f.documento}">${f.documento}</option>`).join('');
                this.ui.populateSelect(this.ui.elements.facturaSelect, optionsHtml, 'Seleccione una factura');
            }

            showFacturaDetails() {
                const documento = this.ui.elements.facturaSelect.value;
                const factura = this.facturasPendientes.find(f => f.documento === documento);
                if (factura) {
                    this.ui.showFacturaDetails(factura);
                }
            }

            async loadBcvRate() {
                try {
                    const rate = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .obtenerTasaBCV();
                    });
                    this.ui.updateBcvRate(rate);
                } catch (error) {
                    this.ui.updateBcvRate(null);
                    this.ui.showNotification(`Error al cargar tasa BCV: ${error.message}`, 'error');
                }
            }

            async loadRecords(vendedor = this.currentVendedor) {
                this.ui.elements.recordsStatus.textContent = 'Cargando registros...';
                try {
                    const registros = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .obtenerRegistrosEnviados(vendedor);
                    });
                    this.ui.updateRecordsTable(registros);
                } catch (error) {
                    this.ui.elements.recordsStatus.textContent = `Error al cargar registros: ${error.message}`;
                    this.ui.showNotification(`Error al cargar registros: ${error.message}`, 'error');
                }
            }

            async submitForm() {
                if (!this.validarFormulario()) {
                    this.ui.showNotification('Por favor, corrija los errores en el formulario.', 'error');
                    return;
                }
                const formData = new FormData(this.ui.elements.form);
                const data = Object.fromEntries(formData.entries());
                data.nombreCliente = this.ui.elements.clienteSelect.options[this.ui.elements.clienteSelect.selectedIndex].text;
                this.ui.toggleLoading(true);
                try {
                    const response = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .enviarDatos(data);
                    });
                    this.ui.showNotification(response, 'success');
                    this.ui.resetForm();
                    await this.loadRecords();
                } catch (error) {
                    this.ui.showNotification(`Error al enviar: ${error.message}`, 'error');
                } finally {
                    this.ui.toggleLoading(false);
                }
            }

            async deleteRecord() {
                this.ui.hideDeleteModal();
                if (this.registroToDelete) {
                    this.ui.toggleLoading(true);
                    try {
                        const response = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .eliminarRegistro(this.registroToDelete);
                        });
                        this.ui.showNotification(response, 'success');
                        await this.loadRecords();
                    } catch (error) {
                        this.ui.showNotification(`Error al eliminar: ${error.message}`, 'error');
                    } finally {
                        this.ui.toggleLoading(false);
                    }
                }
            }

            setRegistroToDelete(rowIndex) {
                this.registroToDelete = rowIndex;
            }

            clearClientCacheAndReload() {
                clientCache.clear();
                this.loadInitialData(true);
                google.script.run
                    .withSuccessHandler(() => {
                        console.log('Propiedades del script limpiadas.');
                    })
                    .withFailureHandler(error => {
                        this.ui.showNotification(`Error al limpiar propiedades: ${error.message}`, 'error');
                    })
                    .clearScriptProperties();
            }

            validarFormulario() {
                let isValid = true;
                const fields = [
                    { id: 'vendedor', errorId: 'vendedorError', condition: value => value === '' },
                    { id: 'cliente', errorId: 'clienteError', condition: value => value === '' },
                    { id: 'factura', errorId: 'facturaError', condition: value => value === '' },
                    { id: 'monto-pagado', errorId: 'montoError', condition: value => !value || parseFloat(value) <= 0 },
                    { id: 'forma-pago', errorId: 'formaPagoError', condition: value => value === '' },
                    { id: 'banco_emisor', errorId: 'bancoEmisorError', condition: value => value === '' },
                    { id: 'banco_receptor', errorId: 'bancoReceptorError', condition: value => value === '' },
                    { id: 'nro-referencia', errorId: 'referenciaError', condition: value => value.length < 4 || value.length > 20 },
                    { id: 'tipo-cobro', errorId: 'tipoCobroError', condition: value => value === '' },
                    { id: 'fecha-transferencia-pago', errorId: 'fechaError', condition: value => !value || new Date(value) > new Date() }
                ];
                fields.forEach(field => {
                    const value = document.getElementById(field.id).value;
                    const errorElement = document.getElementById(field.errorId);
                    if (field.condition(value)) {
                        errorElement.style.display = 'block';
                        isValid = false;
                    } else {
                        errorElement.style.display = 'none';
                    }
                });
                return isValid;
            }
        }

        const uiManager = new UiManager();
        const dataManager = new DataManager(uiManager);

        document.addEventListener('DOMContentLoaded', () => {
            // **CAMBIO CLAVE**: Se fuerza la actualización de datos en cada carga de la página.
            dataManager.loadInitialData(true);

            uiManager.elements.vendedorSelect.addEventListener('change', () => {
                dataManager.loadClientes();
                dataManager.loadRecords(uiManager.elements.vendedorSelect.value);
            });
            uiManager.elements.clienteSelect.addEventListener('change', () => dataManager.loadFacturas());
            uiManager.elements.facturaSelect.addEventListener('change', () => dataManager.showFacturaDetails());
            uiManager.elements.form.addEventListener('submit', (e) => {
                e.preventDefault();
                dataManager.submitForm();
            });
            uiManager.elements.recordsTableBody.addEventListener('click', (e) => {
                if (e.target.closest('.ghost-delete')) {
                    const rowIndex = e.target.closest('.ghost-delete').dataset.rowIndex;
                    dataManager.setRegistroToDelete(rowIndex);
                    uiManager.showDeleteModal();
                }
            });
            document.getElementById('refresh-data-btn').addEventListener('click', () => {
                dataManager.clearClientCacheAndReload();
                uiManager.showNotification('Datos actualizados.', 'success');
            });
            uiManager.elements.confirmDeleteBtn.addEventListener('click', () => dataManager.deleteRecord());
            uiManager.elements.cancelDeleteBtn.addEventListener('click', () => uiManager.hideDeleteModal());
            window.onclick = (event) => {
                if (event.target == uiManager.elements.deleteModal) {
                    uiManager.hideDeleteModal();
                }
            };

            uiManager.elements.logoutButton.addEventListener('click', () => {
                uiManager.elements.logoutButton.disabled = true;
                uiManager.elements.logoutButton.textContent = 'Cerrando...';
                google.script.run
                    .withSuccessHandler(() => {
                        window.top.location.href = webAppUrl;
                    })
                    .withFailureHandler((error) => {
                        uiManager.showNotification(`Error al cerrar sesión: ${error.message}`, 'error');
                        uiManager.elements.logoutButton.disabled = false;
                        uiManager.elements.logoutButton.textContent = 'Cerrar Sesión';
                    })
                    .logoutUser();
            });
        });
    </script>
</body>
</html>